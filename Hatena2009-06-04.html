<!DOCTYPE html>
<html lang="en"><head><title>Hatena2009-06-04</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="🪴 Quartz 4.0"/><meta property="og:title" content="Hatena2009-06-04"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Hatena2009-06-04"/><meta name="twitter:description" content="hatena &lt;body> *1244111079* Complete minimum hash In the previous article &quot;&lt;a href='d.hatena.ne.jp/nishiohirokazu/20090602/1243912419'>I'm ..."/><meta property="og:description" content="hatena &lt;body> *1244111079* Complete minimum hash In the previous article &quot;&lt;a href='d.hatena.ne.jp/nishiohirokazu/20090602/1243912419'>I'm ..."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="hatena &lt;body> *1244111079* Complete minimum hash In the previous article &quot;&lt;a href='d.hatena.ne.jp/nishiohirokazu/20090602/1243912419'>I'm ..."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:width" content="1200"/><meta property="og:height" content="630"/><meta property="og:image:url" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta name="twitter:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="twitter:domain" content="quartz.jzhao.xyz"/><meta property="og:url" content="https:/quartz.jzhao.xyz/Hatena2009-06-04"/><meta property="twitter:url" content="https:/quartz.jzhao.xyz/Hatena2009-06-04"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="hatena &lt;body> *1244111079* Complete minimum hash In the previous article &quot;&lt;a href='d.hatena.ne.jp/nishiohirokazu/20090602/1243912419'>I'm ..."/><meta name="generator" content="Quartz"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("./static/contentIndex.json").then(data => data.json())</script></head><body data-slug="Hatena2009-06-04"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href=".">🪴 Quartz 4.0</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="./">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Hatena2009-06-04</a></div></nav><h1 class="article-title">Hatena2009-06-04</h1><p show-comma="true" class="content-meta"><span>Jun 04, 2009</span><span>5 min read</span></p></div></div><article class="popover-hint"><p>hatena</p>
<pre><code>&lt;body>
*1244111079* Complete minimum hash
In the previous article &quot;&lt;a href='http://d.hatena.ne.jp/nishiohirokazu/20090602/1243912419'>I'm not good at arithmetic&lt;/a>,&quot; I mentioned that I wrote a program to calculate the number of possible phases because it would be tedious for a human to calculate the total number of possible phases. And I was going to &quot;create a *function* in the C language sense to encode/decode from a phase to an integer in the smallest possible range&quot;, which is in essence a perfect minimum hash. I didn't connect the two in my head.

There is nothing difficult about And, Or, Choice, and Resource#take, but Unordered is difficult. Unordered(X + Y) is rewritten as Unordered(X) + X * Y + Unordered(Y) when it is generated, which is sufficient if you just want to count numbers, but if you want to encode them, the X * Y part is rewritten as &quot;one argument is X and the second argument is Y&quot; and vice versa. If you want to encode, however, you need a code to normalize the case where the first argument is X and the second argument is Y, and vice versa.

Oh, I tried to solve that problem by adding an option to And that spits out normalization code, but that doesn't work...the result of expanding Unordered has to be another special Or? Do we need a node that takes two flags for branching and splits the case three ways? But what if the node itself is also in And or Unordered? Hmmm...we need to group them together just like Or.

Let's get this straight: why was it necessary to group the Or's so that they were the outermost? Because when Resource#take is performed from the same resource, whether or not it is taken on one side affects the choices that can be made on the other side. Therefore, when we have And(And(Or(r.take(), X), Y)), we expand it to Or(And(r.take(), Y), And(X, Y))) and make it a parallel world by passing a deepcopy context at the branch of Or. And finally, add them together.

Oh, I see, I'm trying to do the conditional branching of Or with only the given flags, so (X, Y) and (Y, X) are split into different parts, and that's a problem. should I give Or an option to do that too?

&lt;hr>
>|python|
    x = Choice(3, &quot;foo&quot;)
    y = Choice(5, &quot;bar&quot;)
    rule = Unordered(Or(x, y, &quot;is_bar&quot;))
||&lt;
This is.
>|python|
Or(
    And(Choice(3), Choice(5)), 
    Or(
        Unordered(Choice(3)), 
        Unordered(Choice(5))))
||&lt;
in this way

(Deleted due to length)

It looks like this. It takes 6 arguments: foo_0, foo_1, bar_0, bar_1, is_bar_0, is_bar_1, is_bar_0, is_bar_1, and returns the value of or2.

And the decoder will put the passed integer into or2 and then

(Deleted due to length)

I guess I'm wrong about xor = False for now...just as encode computes the value of xor from the two flags before branching, decode must use the value of xor after branching to compute the value of the two flags. So now I'm just using a fixed name for xor because it's a temporary variable, but I need to give it a unique name because it could be nested.


Moo. Chaos. Maybe I should have made a graph of dependencies and then put it in code.

&lt;hr>

The test started running to encode and decode the arguments I gave it. There are bumpy pitfalls. It's like solving a puzzle one by one.

&lt;hr>
Let's see. As long as it's an error, it's still good. It's bad when you run to the end and the answer is wrong.
{'bar_1': 3, 'bar_0': 2, 'is_bar_1': True, 'is_bar_0': True} encoded as {'or2': 10}. Um, I guess this is right.
>||
□
□□
□□□
□□■
□□
||&lt;
Yeah, it's 0-origin, so it's the 10th. Why is this wrong when decoding this? The code for the relevant part of the decoder in the output
>|python|
is_bar_0 = False
if or2 &lt; 21:
    is_bar_xor = True
    or1 = or2
    if or1 &lt; 15:
        is_bar_0 = True
        unordered1 = or1
        n = 5
        choice1_0 = 0
        while unordered1 >= n:
            unordered1 -= n
            choice1_0 += 1
        choice1_1 = unordered1
        bar_0 = choice1_0
        bar_1 = choice1_1
||&lt;
The decoder that is outputting is totally wrong. Mhm, the result still doesn't match. Oh, bar_0 = choice1_0 is correct bar_0 = choice1_0 + choice1_1? No. Is it correct that choice1_1 = unordered1 becomes choice1_1 = unordered1 + choice1_0? Yes, it is.

&lt;hr>

What do I do next, I tested And(Or(Choice, Choice)) and then Unordered(Or(Choice, Choice)), so I guess I'm missing a test for Resource#take.

&lt;hr>

I passed the test for that, and I was happy to get rid of the giraffe.

>||
    if kirin_is_mochigoma_1:
        ,  = _0, _1
    else:
        ,  = _1, _0
    take0 = kirin
||&lt;

Ugh. The And marked &quot;Converted with Unordered&quot; as a result of term rewriting has another And directly under it, so the var_name attribute is empty. What to do with this? > Or(And(And(Take(Resource(X)), Choice(2)), And(Choice(1)), Choice(2))), Or(Unordered(And(Take(Resource(X))), Choice(2))), Unordered(And( Choice(1), Choice(2)))))

Ah, I see, it is not only the variable name corresponding to the node directly under it that is copied by Unordered, but the entire descendant node is copied.
>|python|
        self.vars = [(typ, name + suffix, comment) 
                     for (typ, name, comment) in rule.vars
                     for suffix in [&quot;_0&quot;, &quot;_1&quot;]]
||&lt;
So the subject to be restored here can also use this.
&lt;/body>
</code></pre>
<h2 id="hatena-diary-2009-06-04"><a href="https://nishiohirokazu.hatenadiary.org/archive/2009/06/04" class="external">Hatena Diary 2009-06-04<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hatena-diary-2009-06-04" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This page is auto-translated from <a href="https://scrapbox.io/nishio/Hatena2009-06-04" class="external">/nishio/Hatena2009-06-04<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> using DeepL. If you looks something interesting but the auto-translated English is not good enough to understand it, feel free to let me know at <a href="https://twitter.com/nishio_en" class="external">@nishio_en<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. I’m very happy to spread my thought to non-Japanese readers.</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li>No backlinks found</li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> © 2024</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="./postscript.js" type="module"></script></html>