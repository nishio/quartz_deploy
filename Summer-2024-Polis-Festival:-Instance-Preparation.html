<!DOCTYPE html>
<html lang="en"><head><title>Summer 2024 Polis Festival: Instance Preparation</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="ü™¥ Quartz 4.0"/><meta property="og:title" content="Summer 2024 Polis Festival: Instance Preparation"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Summer 2024 Polis Festival: Instance Preparation"/><meta name="twitter:description" content="from Summer Polis Festival 2024 Summer 2024 Polis Festival: Instance Preparation 2024-06-18 See previous post: Polis in EC2. Create an instance with Ubuntu / t2.medium / 8GB as appropriate Previously, direct clone was done, but this time fork is done."/><meta property="og:description" content="from Summer Polis Festival 2024 Summer 2024 Polis Festival: Instance Preparation 2024-06-18 See previous post: Polis in EC2. Create an instance with Ubuntu / t2.medium / 8GB as appropriate Previously, direct clone was done, but this time fork is done."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="from Summer Polis Festival 2024 Summer 2024 Polis Festival: Instance Preparation 2024-06-18 See previous post: Polis in EC2. Create an instance with Ubuntu / t2.medium / 8GB as appropriate Previously, direct clone was done, but this time fork is done."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:width" content="1200"/><meta property="og:height" content="630"/><meta property="og:image:url" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta name="twitter:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="twitter:domain" content="quartz.jzhao.xyz"/><meta property="og:url" content="https:/quartz.jzhao.xyz/Summer-2024-Polis-Festival:-Instance-Preparation"/><meta property="twitter:url" content="https:/quartz.jzhao.xyz/Summer-2024-Polis-Festival:-Instance-Preparation"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="from Summer Polis Festival 2024 Summer 2024 Polis Festival: Instance Preparation 2024-06-18 See previous post: Polis in EC2. Create an instance with Ubuntu / t2.medium / 8GB as appropriate Previously, direct clone was done, but this time fork is done."/><meta name="generator" content="Quartz"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("./static/contentIndex.json").then(data => data.json())</script></head><body data-slug="Summer-2024-Polis-Festival:-Instance-Preparation"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href=".">ü™¥ Quartz 4.0</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="./">Home</a><p> ‚ùØ </p></div><div class="breadcrumb-element"><a href>Summer 2024 Polis Festival: Instance Preparation</a></div></nav><h1 class="article-title">Summer 2024 Polis Festival: Instance Preparation</h1><p show-comma="true" class="content-meta"><span>Jun 23, 2024</span><span>24 min read</span></p></div></div><article class="popover-hint"><p>from  <a href="./Summer-Polis-Festival-2024" class="internal alias" data-slug="Summer-Polis-Festival-2024">Summer Polis Festival 2024</a>
Summer 2024 Polis Festival: Instance Preparation</p>
<p>2024-06-18</p>
<p>See previous post: <a href="./Polis-in-EC2" class="internal alias" data-slug="Polis-in-EC2">Polis in EC2</a>.</p>
<ul>
<li>Create an instance with Ubuntu / t2.medium / 8GB as appropriate</li>
</ul>
<p>Previously, direct clone was done, but this time fork is done.
- I might do some Japaneseization of the UI.</p>
<ul>
<li><a href="https://github.com/compdemocracy/polis" class="external">GitHub - compdemocracy/polis: :milky_way: Open Source AI for large scale open ended feedback<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><img src="https://gyazo.com/59cc15bdfd0b814b53dc798d337cd407/thumb/1000" alt="image"/></li>
<li>What‚Äôs this?
<ul>
<li>I don‚Äôt know, so let‚Äôs make it the default.</li>
</ul>
</li>
<li><a href="https://github.com/nishio/polis" class="external">https://github.com/nishio/polis<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
<ul>
<li><img src="https://gyazo.com/f67f3503e112a32eaad59e85e5d981b1/thumb/1000" alt="image"/>
<ul>
<li>hmm</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>In the meantime, the instance was activated.
<img src="https://gyazo.com/00f7959982e7d683ba30c9434fa8ce5c/thumb/1000" alt="image"/><img src="https://gyazo.com/047782a83e3b394c143f62e1f7d9d9cf/thumb/1000" alt="image"/></p>
<p>Install Docker</p>
<ul>
<li><a href="https://docs.docker.com/engine/install/ubuntu/" class="external">Install Docker Engine on Ubuntu | Docker Documentation<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>Hello world: OK</li>
</ul>
<h1 id="install-polis">install Polis<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#install-polis" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>.
<code>$ cp example.env .env</code>
<code>$ make start</code>
:</p>
<pre><code>docker compose -f docker-compose.yml -f docker-compose.dev.yml --env-file .env up
permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get &quot;http://%2Fvar%2Frun%2Fdocker.sock/v1.45/containers/json?all=1&amp;filters=%7B%22label%22%3A%7B%22com.docker.compose.config-hash%22%3Atrue%2C%22com.docker.compose.project%3Dpolis-dev%22%3Atrue%7D%7D&quot;: dial unix /var/run/docker.sock: connect: permission denied
make: *** [Makefile:34: start] Error 1
</code></pre>
<p>well
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>This error occurs because the current user does not have permission to access the Docker daemon socket.</p>
<ul>
<li><code>$ sudo usermod -aG docker $USER</code></li>
<li><code>$ newgrp docker</code>
Build is in motion.</li>
<li>There‚Äôs some kind of log going around, but I‚Äôm not sure if the build is finished and the server is running or if it‚Äôs still building.</li>
<li><code>http://&lt;IP>/createuser</code>
<ul>
<li>It worked.</li>
<li><img src="https://gyazo.com/e64501b8e819a3cb978a668dfddb172e/thumb/1000" alt="image"/></li>
</ul>
</li>
<li>When you create an account
:</li>
</ul>
<pre><code>server-1       | info: not whitelisted  ... ,&quot;path&quot;:&quot;/api/v3/auth/new&quot;,&quot;service&quot;:&quot;polis-api-server&quot;,&quot;timestamp&quot;:&quot;2024-06-18 08:07:22 +00:00&quot;}
server-1       | POST /api/v3/auth/new 500 160.657 ms - 40
server-1       | unauthorized domain: http://&lt;IP>
</code></pre>
<ul>
<li>That‚Äôs what happened last time.
<ul>
<li>Because it‚Äôs not on the white list.</li>
<li>It‚Äôs HTTP, it‚Äôs IP rounding, it‚Äôs a problem.</li>
<li>This was the development mode to begin with.</li>
</ul>
</li>
<li>I‚Äôll try PROD.
<ul>
<li><code>$ cp example.env prod.env</code></li>
<li><code>$ make PROD start</code></li>
<li>I got access.</li>
</ul>
</li>
</ul>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>
1. obtaining and setting up a domain name
2. obtain an SSL certificate with Let's Encrypt
3. configuration of Nginx
    - Set up a reverse proxy using Nginx to support HTTPS.
<p>Eh, sounds like a pain in the ass.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/></p>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>
1. AWS Elastic Beanstalk
- Benefits
    - Easy Deployment: Just upload your code and the infrastructure is automatically built.
    - Reduced management effort: environment scaling, load balancing, and monitoring are automated.
    - Integration: Integrated with ACM for easy HTTPS certificate application.
- Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages
    - Limitations: Restrictions apply when a high degree of customization is required.
    - Cost: Can be somewhat higher than other methods.
2. AWS Fargate
- Benefits
    - Serverless: Eliminates the need for infrastructure management.
    - Scalability: Automatic scaling to handle high traffic.
    - Flexibility: Because it uses ECS clusters, it can be configured and customized in detail.
- Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages
    - Learning Cost: Some time is required for initial setup and understanding.
    - Cost: Charges are based on usage, so ongoing cost control is necessary.
3. AWS Lightsail
- Benefits
    - Easy setup: The interface is very easy to set up for beginners.
    - Fixed fee: The fee structure is easy to understand and manage budgets.
    - Integration: Easy configuration of SSL certificates and use of load balancers.
- Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages: -Disadvantages
    - Limitations: Not suited for advanced scaling or complex infrastructure setups.
    - Flexibility: Less customizable than other AWS services.
summary
- AWS Elastic Beanstalk: ideal if you want to deploy easily but can accept some limitations.
- AWS Fargate: best if you need flexibility and scalability but can accept the learning costs of initial setup.
- AWS Lightsail: ideal for beginners who want an easy and cost-effective solution.
Each method has its advantages and disadvantages, and it is important to choose the best method for your specific requirements and budget.
<p>I have no idea which one is better.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/></p>
<ul>
<li>GPT4, you got it!
<ul>
<li>‚ÜíLet‚Äôs Encrypt + Nginx route</li>
<li>I can‚Äôt judge, so I‚Äôll go with that.</li>
</ul>
</li>
</ul>
<p><img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>Add DNS records for subdomains</p>
<ul>
<li>Open the DNS settings for ‚Äúnhiro.org‚Äù and add an A record to point ‚Äúpolis.nhiro.org‚Äù to the IP address of the EC2 instance, as shown below.
<ul>
<li>Host Name: polis</li>
<li>Type: A</li>
<li>TTL: 600 (or default value)</li>
<li>Value: EC2 public IP address</li>
</ul>
</li>
</ul>
<p><img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>To check if the DNS has been updated, use the following methods</p>
<ul>
<li>nslookup</li>
<li>dig</li>
</ul>
<p><img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>It seems that your DNS settings are not reflected correctly. Please check the following steps.
2. clear DNS cache
- macOS
- <code>$ sudo killall -HUP mDNSResponder</code></p>
<p>Whoa, it‚Äôs been updated.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/></p>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>
Installation of Nginx
`$ sudo apt update`
`$ sudo apt install -y nginx`
Edit Nginx configuration file
`$ sudo vi /etc/nginx/sites-available/default`
:
<pre><code>server {
    listen 80;
    server_name your_domain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name your_domain.com;

    ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
</code></pre>
<p>With vi, screen is broken, OK with nano.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/></p>
<p>Install Certbot
<code>$ sudo apt install -y certbot python3-certbot-nginx</code>
Obtaining an SSL Certificate
<code>$ sudo certbot --nginx -d polis.nhiro.org</code></p>
<p>:</p>
<pre><code>Saving debug log to /var/log/letsencrypt/letsencrypt.log
Error while running nginx -c /etc/nginx/nginx.conf -t.

2024/06/18 08:59:32 [emerg] 12342#12342: cannot load certificate &quot;/etc/letsencrypt/live/your_domain.com/fullchain.pem&quot;: BIO_new_file() failed (SSL: error:80000002:system library::No such file or directory:calling fopen(/etc/letsencrypt/live/your_domain.com/fullchain.pem, r) error:10000080:BIO routines::no such file)
nginx: configuration file /etc/nginx/nginx.conf test failed

The nginx plugin is not working; there may be problems with your existing configuration.
The error was: MisconfigurationError('Error while running nginx -c /etc/nginx/nginx.conf -t.\n\n2024/06/18 08:59:32 [emerg] 12342#12342: cannot load certificate &quot;/etc/letsencrypt/live/your_domain.com/fullchain.pem&quot;: BIO_new_file() failed (SSL: error:80000002:system library::No such file or directory:calling fopen(/etc/letsencrypt/live/your_domain.com/fullchain.pem, r) error:10000080:BIO routines::no such file)\nnginx: configuration file /etc/nginx/nginx.conf test failed\n')
</code></pre>
<p><img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>This error indicates that Nginx cannot load the configuration because the Let‚Äôs Encrypt certificate does not exist.
There is no way!<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>Temporarily comment out the SSL portion from the Nginx configuration.</p>
<p>:</p>
<pre><code>$ sudo certbot --nginx -d polis.nhiro.org
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): nishio.hirokazu@gmail.com 

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.4-April-3-2024.pdf. You must agree in
order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: y

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: y
Account registered.
Requesting a certificate for polis.nhiro.org

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/polis.nhiro.org/privkey.pem
This certificate expires on 2024-09-16.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

Deploying certificate
Successfully deployed certificate for polis.nhiro.org to /etc/nginx/sites-enabled/default
Congratulations! You have successfully enabled HTTPS on https://polis.nhiro.org

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</code></pre>
<p>I heard it was done?</p>
<p>:</p>
<pre><code>$ sudo systemctl restart nginx
Job for nginx.service failed because the control process exited with error code.
See &quot;systemctl status nginx.service&quot; and &quot;journalctl -xeu nginx.service&quot; for details.
</code></pre>
<p>:</p>
<pre><code>Jun 18 09:04:06 ip-172-31-37-50 nginx[12385]: 2024/06/18 09:04:06 [emerg] 12385#12385: cannot load certificate &quot;/etc/letsencrypt/live/your_domain.com/fullchain.pem&quot;: BIO_new_file() failed (>
Jun 18 09:04:06 ip-172-31-37-50 nginx[12385]: nginx: configuration file /etc/nginx/nginx.conf test failed
</code></pre>
<p>Uh, <code>certificate &quot;/etc/letsencrypt/live/your_domain.com/fullchain.pem&quot;</code></p>
<ul>
<li>I didn‚Äôt know <code>your_domain.com</code> was still there.</li>
</ul>
<p><code>$ sudo systemctl restart nginx</code></p>
<ul>
<li>This time he says nothing. Success?</li>
</ul>
<p>Activate Polis
:</p>
<pre><code>Error response from daemon: driver failed programming external connectivity on endpoint polis-dev-nginx-proxy-1 (432b7de15349df46efb04a246102c6e420b7fdd790f2d3580a4ad0afc313a5cd): Error starting userland proxy: listen tcp4 0.0.0.0:443: bind: address already in use
</code></pre>
<p>Ahhhhhh‚Ä¶</p>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>
First, check which process is using port 443.
- `$ sudo lsof -i :443`
Well, usually nginx.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/>
<p>If a process using port 443 is unnecessary, stop it. For example, if Nginx is already running, stop it.
<code>$ sudo systemctl stop nginx</code></p>
<p>Once the port is released, start the Nginx container again.</p>
<p>This time it seems to be working properly, but when I access it from my browser, it doesn‚Äôt respond‚Ä¶ haha, that‚Äôs the one!
<img src="https://gyazo.com/426f81bb560937f83463a1298af31a82/thumb/1000" alt="image"/>
443 is not enough</p>
<ul>
<li>I‚Äôve made this mistake 100 times in my life (exaggeration).</li>
</ul>
<p><img src="https://gyazo.com/f213f68acb74c12ef23164f7b24a7ea1/thumb/1000" alt="image"/>
Well, why not?
<img src="https://gyazo.com/4c7ea8af3dc9a8dbe33e0aca9e940f98/thumb/1000" alt="image"/>
Why invalid?
<img src="https://gyazo.com/27c8b19fe6415a83505e6f34882f8cbb/thumb/1000" alt="image"/>
Ehhhhhh‚Ä¶</p>
<p>„Äú„Äú„Äú</p>
<p>Oh, I remember reading in the Polis side documentation that the default is a test certificate!
I guess I need to change the settings on the Polis side.
<a href="https://github.com/nishio/polis/blob/edge/docs/ssl.md" class="external">polis/docs/ssl.md at edge ¬∑ nishio/polis<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
rewrite
<code>$ sudo systemctl restart nginx</code></p>
<p>:</p>
<pre><code>$ sudo nginx -t
2024/06/18 14:18:04 [warn] 53602#53602: conflicting server name &quot;polis.nhiro.org&quot; on 0.0.0.0:443, ignored
</code></pre>
<p>:</p>
<pre><code>ubuntu@ip-172-31-37-50:~/polis$ grep -r &quot;server_name polis.nhiro.org&quot; /etc/nginx/
/etc/nginx/sites-available/default:    server_name polis.nhiro.org;
/etc/nginx/sites-available/default:    server_name polis.nhiro.org;
/etc/nginx/sites-available/default:    server_name polis.nhiro.org;
ubuntu@ip-172-31-37-50:~/polis$ grep -r &quot;server_name polis.nhiro.org&quot; .
./file-server/nginx/nginx-ssl.site.default.conf:    server_name polis.nhiro.org;
</code></pre>
<p>Copying configuration files in nginx.Dockerfile
<a href="./Polis#646c4176aff09e0000018cef-on-ec2" class="internal alias" data-slug="Polis">646c4176aff09e0000018cef on EC2</a>
Don‚Äôt mess with the Dockerfile, point to the letsencrypt certificate in the conf</p>
<p>Something doesn‚Äôt work, let‚Äôs go to bed.</p>
<p>2024-06-19
Go to sleep, wake up and think again with a clear head.</p>
<p>First of all, you should verbalize and transmit what you‚Äôre trying to do and for what purpose.</p>
<ul>
<li>I wrote in the opening section</li>
</ul>
<p>Current Issues</p>
<ul>
<li>My technical skills around servers are low and I‚Äôm stumped.</li>
</ul>
<p>First calmly check what is happening in order from the entry point
<a href="https://github.com/nishio/polis" class="external">https://github.com/nishio/polis<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
opened with <a href="./cursor" class="internal" data-slug="cursor">cursor</a>.</p>
<p>What happens when I make PROD start?</p>
<p>When you run make PROD start, the following happens
PROD target is executed: 1.
ENV_FILE is set to prod.env.
TAG is taken from the prod.env file.
COMPOSE_FILE_ARGS is set to -f docker-compose.yml.
2. start Target is executed: 1.
The echo_vars target is executed and the current ENV_FILE and TAG values are displayed.
The docker compose command starts all Docker containers using COMPOSE_FILE_ARGS and ENV_FILE.
The specific command flow is as follows
make</p>
<pre><code>PROD: ## Run in prod mode (e.g. `make PROD start`, etc.) using config in `prod.env`
	$(eval ENV_FILE = prod.env)
	$(eval TAG = $(shell grep -e ^TAG ${ENV_FILE} | awk -F'[=]' '{gsub(/ /,&quot;&quot;);print $$2}'))
	$(eval COMPOSE_FILE_ARGS = -f docker-compose.yml)

start: echo_vars ## Start all Docker containers
	docker compose ${COMPOSE_FILE_ARGS} --env-file ${ENV_FILE} up
</code></pre>
<p>This results in a Docker container being launched based on the settings in the prod.env file.</p>
<p>What happens when docker-compose.yml is executed?</p>
<p>When docker-compose.yml is executed, the following happens
Containers are created and started based on the service definition: 1.
The server, math, postgres, nginx-proxy, and file-server services are defined, and a Docker image corresponding to each service is built or pulled.
Each service is started according to the specified environment variables, volume, and network settings.
Network creation: 1.
A custom network called polis-net is created and all services are connected to this network.
3. volume creation: (1)
Volumes named backups, postgres, and server-logs are created and mounted on the corresponding services.
The specific service operation is as follows
server:
. Build a Docker image from the /server directory and use the prod target.
Store logs in the server-logs volume.
Depends on postgres and file-server.
math:
. /math directory to build the Docker image.
Set necessary environment variables.
Depends on postgres.
postgres:
. /server directory to build an image using Dockerfile-db.
Set database environment variables.
backups and postgres volumes.
nginx-proxy:
. Build an image from the /file-server directory using nginx.Dockerfile.
Depends on server.
Ports 80 and 443 are exposed to the host.
file-server:
Build the image from the root directory using file-server/Dockerfile.
Set necessary environment variables.
This allows all services to work together and launch the entire application.</p>
<p>(Is there a file for nginx-proxy in file-server? <img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/>)</p>
<p>I‚Äôm trying to solve the problem of Nginx using a test certificate, should I read nginx.Dockerfile next?</p>
<p>Yes, then reading the nginx.Dockerfile is a good approach: by reviewing the nginx.Dockerfile, you can understand the build process of the Nginx image and which certificates are being used.
Please pay particular attention to the following points for confirmation</p>
<ol>
<li>a copy of the certificate: 1.
Where in the Dockerfile the certificate file is copied from.
In which directory it is located.
Nginx configuration files: 1.
How the certificate path is specified in the Nginx configuration file.
Build Context: 3.
Does the build context contain the correct certificate file?
By reviewing this information, you can determine the cause of problems that result in test certificates being used and correct them to use the appropriate certificates.</li>
</ol>
<p>In the nginx.Dockerfile I have a copy of the configuration file and the test certificate. I assume if I edit the configuration file properly it will read the production certificate?</p>
<p>Yes, you can configure Nginx to use a production certificate by properly editing its configuration file. You may wish to proceed as follows
Prepare certificate for production: 1.
Place the production certificate (cert.pem) and private key (key.pem) in the appropriate directories.
Edit Nginx configuration file: 1.
Edit the file nginx/nginx-ssl.site.default.conf and specify the paths for the production certificate and private key.
As an example, edit part of the Nginx configuration file as follows
:</p>
<pre><code>server {
    listen 443 ssl;
    server_name your_domain.com;

    ssl_certificate /etc/nginx/certs/your_production.cert.pem;
    ssl_certificate_key /etc/nginx/certs/your_production.key.pem;

    # Other settings
}
</code></pre>
<p>Dockerfile modification: 1.
Modify nginx.Dockerfile to copy the production certificate to the Docker image.
:</p>
<pre><code>FROM docker.io/nginx:1.21.5-alpine
COPY nginx/nginx-ssl.site.default.conf /etc/nginx/conf.d/default.conf
COPY nginx/certs/your_production.cert.pem /etc/nginx/certs/your_production.cert.pem
COPY nginx/certs/your_production.key.pem /etc/nginx/certs/your_production.key.pem

EXPOSE 80
EXPOSE 443
</code></pre>
<p>This allows Nginx to be started with a production certificate.</p>
<p>Ahh! Okay, okay.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/>
You have to copy the certificate on the host machine to the Docker image, but you‚Äôre specifying it by path with the same machine‚Äôs feelings, that‚Äôs it.</p>
<p>dockerfile</p>
<pre><code>COPY /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem /etc/nginx/certs/nhiro-fullchain.pem
COPY /etc/letsencrypt/live/your_domain.com/privkey.pem /etc/nginx/certs/nhiro-privkey.pem
</code></pre>
<p>nginx/nginx-ssl.site.default.conf</p>
<pre><code>ssl_certificate /etc/nginx/certs/nhiro-fullchain.pem;
ssl_certificate_key /etc/nginx/certs/nhiro-privkey.pem;
</code></pre>
<p>I make PROD start but my browser continues to warn me about the test certificate, why?</p>
<p>If you continue to get a test certificate warning in your browser after running make PROD start, there are several possible causes. Please check the following points
Docker image cache: 1.
The Docker image may be cached. Try disabling the cache and build again.
cache
Reload Nginx configuration: 1.
Nginx may not have loaded the new configuration; try restarting the Nginx container.
proxy
3. check the certificate path:.
Make sure the correct certificate is copied in the nginx.Dockerfile. Also, make sure that the correct path is specified in the Nginx configuration file.
Certificate validity: 4.
Verify that the certificate for production has been issued correctly and has not expired.
Browser cache: 5.
Your browser cache may be causing an outdated certificate to be displayed. Try clearing your browser cache.
6. check Docker Compose file: (1)
Make sure you have the correct configuration in the docker-compose.yml file. In particular, check the configuration of the Nginx container.
If these points do not resolve the problem, specific error messages or logs may help identify the cause of the problem.</p>
<p>It looks like we‚Äôll have the means to do 1 or 2 with make.</p>
<p>You may have a way to disable the cache of the Docker image using the make command, rebuild it, and restart the Nginx container. Check the target in the Makefile below:
Build with cache disabled: 1.
A build-no-cache target is provided. This can be used to build Docker images without caching.</p>
<ol start="2">
<li>restart container:.
A start-recreate target is provided. This can be used to recreate and start the container.</li>
</ol>
<p>Running a combination of these commands may solve the problem.</p>
<ul>
<li><a href="./Monitoring-with-CloudWatch" class="internal alias" data-slug="Monitoring-with-CloudWatch">Monitoring with CloudWatch</a> 1</li>
</ul>
<p>Oh, make is rubbing off.
:</p>
<pre><code>------
 > [nginx-proxy 5/6] COPY /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem /etc/nginx/certs/nhiro-fullchain.pem:
------
------
 > [nginx-proxy 6/6] COPY /etc/letsencrypt/live/your_domain.com/privkey.pem /etc/nginx/certs/nhiro-privkey.pem:
------
failed to solve: failed to compute cache key: failed to calculate checksum of ref fdb69f4f-67cc-489f-8061-2f3a24921a15::imnifc4l0wil7tzgrsjx1ezl9: &quot;/etc/letsencrypt/live/your_domain.com/privkey.pem&quot;: not found
make: *** [Makefile:61: build-no-cache] Error 17
</code></pre>
<p>Is it because the owner is root?</p>
<p>:</p>
<pre><code>27.89 Downloading: com/cnuernber/jarrow/1.000/jarrow-1.000.jar from clojars
27.90 Error building classpath. Could not transfer artifact org.apache.commons:commons-math3:jar:3.6.1 from/to central (https://repo1.maven.org/maven2/): No space left on device
------
failed to solve: process &quot;/bin/sh -c clojure -A:dev -P&quot; did not complete successfully: exit code: 1
make: *** [Makefile:61: build-no-cache] Error 17
</code></pre>
<p>procedure
Check disk space: 1.
Check the disk space on the host machine.</p>
<ul>
<li><code>$ df -h</code>
Delete unnecessary files: 1.
Delete unneeded files, old Docker images, containers, and volumes to free up disk space.
:</li>
</ul>
<pre><code>    # Delete all suspended containers
    docker container prune

    # Remove all unused images
    docker image prune -a

    # Delete all unused volumes
    docker volume prune

    # Remove all unused networks
    docker network prune
</code></pre>
<p>before</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       6.8G  6.5G  217M  97% /
</code></pre>
<p>after</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       6.8G  6.0G  752M  90% /
</code></pre>
<p>No, but it‚Äôs still a cutthroat job.</p>
<p>:</p>
<pre><code>------
 > [file-server client-participation 4/6] RUN npm ci --production=false:
1.505 npm warn config production Use `--omit=dev` instead.
47.22 npm warn tar TAR_ENTRY_ERROR ENOSPC: no space left on device, write
47.28 npm notice
47.28 npm notice New minor version of npm available! 10.7.0 -> 10.8.1
47.28 npm notice Changelog: https://github.com/npm/cli/releases/tag/v10.8.1
47.28 npm notice To update run: npm install -g npm@10.8.1
47.28 npm notice
47.29 npm error code ENOSPC
47.29 npm error syscall write
47.29 npm error errno -28
47.29 npm error nospc ENOSPC: no space left on device, write
47.29 npm error nospc There appears to be insufficient space on your system to finish.
47.29 npm error nospc Clear up some disk space and try again.
47.30 
47.30 npm error A complete log of this run can be found in: /root/.npm/_logs/2024-06-19T05_44_05_167Z-debug-0.log
------
------
 > [file-server client-report 6/7] COPY client-report/. .:
------
failed to solve: process &quot;/bin/sh -c npm ci --production=false&quot; did not complete successfully: exit code: 228
make: *** [Makefile:61: build-no-cache] Error 17
</code></pre>
<p>That‚Äôs no good!</p>
<p>:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       6.8G  6.4G  359M  95% /
</code></pre>
<p>:</p>
<pre><code>    sudo apt-get clean
    sudo apt-get autoremove
</code></pre>
<p>:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       6.8G  6.2G  577M  92% /
</code></pre>
<p>I want to expand, EC2.</p>
<p>To expand the disk space of an EC2 instance, perform the following steps
procedure
Stop EC2 instance: 1.
First, stop the EC2 instance.</p>
<p>EBS volume resizing: 1.
Log in to the EC2 Management Console and locate the EBS volume attached to the target instance.
Select a volume and choose ‚ÄúChange Volume‚Äù from the ‚ÄúAction‚Äù menu.
Save the changes with the new size.</p>
<p>Start EC2 instance: 1.
Restart the instance.</p>
<p>File system extensions: 1.
Connect to the instance via SSH and extend the file system.
:</p>
<pre><code>    # Check root file system device name
    lsblk

    # Assume root file system is /dev/xvda1
    sudo growpart /dev/xvda 1

    # Extend file system
    sudo resize2fs /dev/xvda1
</code></pre>
<blockquote>
<p>Log in to the EC2 Management Console and locate the EBS volume attached to the target instance.
<img src="https://gyazo.com/db22e35a7f140bde02961a3653ed375a/thumb/1000" alt="image"/>
hmm
<img src="https://gyazo.com/8e34baa2baa0825a41c07ba63a211062/thumb/1000" alt="image"/>
<img src="https://gyazo.com/90a31dd0749d83ae2fa54c2b4ac4a5ff/thumb/1000" alt="image"/></p>
</blockquote>
<ul>
<li>Can I start an instance with optimizing (0%)?</li>
</ul>
<p>:</p>
<pre><code>$ lsblk
NAME     MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
loop0      7:0    0 25.2M  1 loop /snap/amazon-ssm-agent/7983
loop1      7:1    0 55.7M  1 loop /snap/core18/2812
loop2      7:2    0 25.2M  1 loop /snap/amazon-ssm-agent/7993
loop3      7:3    0 55.7M  1 loop /snap/core18/2823
loop4      7:4    0 38.7M  1 loop /snap/snapd/21465
loop5      7:5    0 38.8M  1 loop /snap/snapd/21759
xvda     202:0    0   16G  0 disk 
‚îú‚îÄxvda1  202:1    0   15G  0 part /
‚îú‚îÄxvda14 202:14   0    4M  0 part 
‚îú‚îÄxvda15 202:15   0  106M  0 part /boot/efi
‚îî‚îÄxvda16 259:0    0  913M  0 part /boot
</code></pre>
<p>:</p>
<pre><code>$ sudo growpart /dev/xvda 1
NOCHANGE: partition 1 is size 31455199. it cannot be grown
</code></pre>
<p>If you look closely, you‚Äôll see that we‚Äôve already done the growpart equivalent.</p>
<p>:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        15G  6.2G  8.3G  43% /
</code></pre>
<p>File system already extended?</p>
<p>rebuild
error
Ah!
:</p>
<pre><code>COPY /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem /etc/nginx/certs/nhiro-fullchain.pem
COPY /etc/letsencrypt/live/your_domain.com/privkey.pem /etc/nginx/certs/nhiro-privkey.pem
</code></pre>
<p>Your_domain.com‚Äù‚Ä¶</p>
<p>While waiting for the build, I need to update the DNS because the instance restart changed the IP address.
52.91.132.130</p>
<p><img src="https://gyazo.com/d94651674606127524eba837083a2c0e/thumb/1000" alt="image"/>
I‚Äôm not sure I need an agent to get DiskRead or something.</p>
<p>To rebuild only the nginx-proxy container, perform the following steps
:</p>
<pre><code># Stop nginx-proxy container
docker compose stop nginx-proxy

# Remove nginx-proxy container
docker compose rm -f nginx-proxy

# Build nginx-proxy container
docker compose build nginx-proxy

# Restart nginx-proxy container
docker compose up -d nginx-proxy
</code></pre>
<p>:</p>
<pre><code>=> ERROR [nginx-proxy 5/6] COPY /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem /etc/nginx/certs/nhiro-fullchain.pem                                                           0.0s
 => ERROR [nginx-proxy 6/6] COPY /etc/letsencrypt/live/polis.nhiro.org/privkey.pem /etc/nginx/certs/nhiro-privkey.pem                                                               0.0s
------
 > [nginx-proxy 5/6] COPY /etc/letsencrypt/live/polis.nhiro.org/fullchain.pem /etc/nginx/certs/nhiro-fullchain.pem:
------
------
 > [nginx-proxy 6/6] COPY /etc/letsencrypt/live/polis.nhiro.org/privkey.pem /etc/nginx/certs/nhiro-privkey.pem:
------
failed to solve: failed to compute cache key: failed to calculate checksum of ref fdb69f4f-67cc-489f-8061-2f3a24921a15::y630wak98lsqz4tftvmxyloof: &quot;/etc/letsencrypt/live/polis.nhiro.org/privkey.pem&quot;: not found
make: *** [Makefile:61: build-no-cache] Error 17
</code></pre>
<p>abbr. of particle ‚Äúni‚Äù (used especially when it precedes the verb ‚Äúnaru‚Äù)
<code>$ sudo ls /etc/letsencrypt/live/polis.nhiro.org/privkey.pem</code>
/etc/letsencrypt/live/polis.nhiro.org/privkey.pem</p>
<p>Even though there are?</p>
<ol>
<li>check Docker build context
The COPY command in the Dockerfile refers to a file in the build context. The build context may not contain /etc/letsencrypt/live/polis.nhiro.org/privkey.pem.
Method 1: Copy the certificate into the Docker build context</li>
<li>copy the certificate file to the project directory
Copy the certificate file into the project directory.</li>
</ol>
<p>If you copy it, the certbot will keep using the old one when it updates, so maybe you should ln -s it.</p>
<p>It is a good idea to use ln -s to create a symbolic link. This will ensure that Certbot automatically uses the new certificate when it updates it.</p>
<p>such
:</p>
<pre><code>COPY nginx/cert/nhiro-fullchain.pem  /etc/nginx/certs/nhiro-fullchain.pem
COPY nginx/cert/nhiro-privkey.pem /etc/nginx/certs/nhiro-privkey.pem
</code></pre>
<p>:</p>
<pre><code> => ERROR [nginx-proxy 5/6] COPY nginx/cert/nhiro-fullchain.pem  /etc/nginx/certs/nhiro-fullchain.pem                                                                               0.0s
 => ERROR [nginx-proxy 6/6] COPY nginx/cert/nhiro-privkey.pem /etc/nginx/certs/nhiro-privkey.pem                                                                                    0.0s
------
 > [nginx-proxy 5/6] COPY nginx/cert/nhiro-fullchain.pem  /etc/nginx/certs/nhiro-fullchain.pem:
------
------
 > [nginx-proxy 6/6] COPY nginx/cert/nhiro-privkey.pem /etc/nginx/certs/nhiro-privkey.pem:
------
failed to solve: failed to compute cache key: failed to calculate checksum of ref fdb69f4f-67cc-489f-8061-2f3a24921a15::m8mkj6rtbq8r4rggxmzjlbgkw: &quot;/nginx/cert/nhiro-privkey.pem&quot;: not found
make: *** [Makefile:61: build-no-cache] Error 17
</code></pre>
<p>gah</p>
<ul>
<li>‚Äú/nginx/cert/nhiro-privkey.pem‚Äù</li>
<li>Why access /nginx in this context is a mystery</li>
<li>I decided to cp without ln -s
<ul>
<li>I thought we cp‚Äôd last time.</li>
<li>We‚Äôll figure out how to renew the certificate later.</li>
</ul>
</li>
</ul>
<p>I‚Äôve been distracted by the ‚Äúwhy /nginx?‚Äù, but it‚Äôs <code>certs</code>, not <code>cert</code>.</p>
<p>Finally fixed!</p>
<ul>
<li><a href="./Monitoring-with-CloudWatch" class="internal alias" data-slug="Monitoring-with-CloudWatch">Monitoring with CloudWatch</a> 2</li>
</ul>
<p>Certificate error resolved but ‚ÄúConnection refused at polis.nhiro.org‚Äù. to ‚Äúpolis.nhiro.org‚Äù.</p>
<p>:</p>
<pre><code>$ docker logs polis-dev-nginx-proxy-1
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: /etc/nginx/conf.d/default.conf differs from the packaged version
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
2024/06/19 08:48:42 [emerg] 1#1: cannot load certificate key &quot;/etc/nginx/certs/nhiro-privkey.pem&quot;: PEM_read_bio_PrivateKey() failed (SSL: error:0909006C:PEM routines:get_name:no start line:Expecting: ANY PRIVATE KEY)
nginx: [emerg] cannot load certificate key &quot;/etc/nginx/certs/nhiro-privkey.pem&quot;: PEM_read_bio_PrivateKey() failed (SSL: error:0909006C:PEM routines:get_name:no start line:Expecting: ANY PRIVATE KEY)
</code></pre>
<p>Calmly look at the dockerfile again.
:</p>
<pre><code>FROM docker.io/nginx:1.21.5-alpine

COPY nginx/nginx-ssl.site.default.conf /etc/nginx/conf.d/default.conf

# We only use these in testing.
COPY nginx/certs/snakeoil.cert.pem /etc/nginx/certs/snakeoil.cert.pem
COPY nginx/certs/snakeoil.key.pem  /etc/nginx/certs/snakeoil.key.pem

COPY nginx/certs/nhiro-fullchain.pem  /etc/nginx/certs/nhiro-fullchain.pem
COPY nginx/certs/nhiro-privkey.pem /etc/nginx/certs/nhiro-privkey.pem

EXPOSE 80
EXPOSE 443
</code></pre>
<p>I‚Äôm not wrong.</p>
<ol>
<li>check the contents of the certificate file
Verify that the contents of the nhiro-privkey.pem file are in the correct format. Make sure the file begins with -----BEGIN PRIVATE KEY----- or -----BEGIN RSA PRIVATE KEY----- and ends with -----END PRIVATE KEY----- or -----END RSA PRIVATE KEY-----. Make sure that the</li>
</ol>
<p>Verify that the permissions on the certificate file are correct. Verify that Nginx has read permission to the file.
sudo chmod 644 /path/to/your/project/nginx/cert/nhiro-privkey.pem</p>
<p>Ahhhh, 600‚Ä¶<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/></p>
<p>It finally worked!
<img src="https://gyazo.com/64e5abe391390d648c294818eb5a1c39/thumb/1000" alt="image"/>
Known to be unauthorized domain</p>
<p>.env</p>
<pre><code># If you are running polis on a custom domain, set both API_PROD_HOSTNAME and DOMAIN_OVERRIDE
# to the same value. In the future these will be combined into one setting.
API_PROD_HOSTNAME=pol.is
DOMAIN_OVERRIDE=
</code></pre>
<p>Here.
.env</p>
<pre><code>API_PROD_HOSTNAME=polis.nhiro.org
DOMAIN_OVERRIDE=polis.nhiro.org
</code></pre>
<p>Like this.</p>
<p><img src="https://gyazo.com/70cec473da1d47fbb8ef80b2d25a01f3/thumb/1000" alt="image"/>
Isn‚Äôt it <code>https://polis.nhiro.org</code>?</p>
<p>:</p>
<pre><code>info: not whitelisted {&quot;headers&quot;:{&quot;accept&quot;:&quot;application/json, text/javascript, */*; q=0.01&quot;,&quot;accept-encoding&quot;:&quot;gzip, deflate, br, zstd&quot;,&quot;accept-language&quot;:&quot;ja,en-US;q=0.9,en;q=0.8,zh;q=0.7,zh-CN;q=0.6,zh-HK;q=0.5,zh-TW;q=0.4&quot;,&quot;cache-control&quot;:&quot;max-age=0&quot;,&quot;connection&quot;:&quot;close&quot;,&quot;content-length&quot;:&quot;97&quot;,&quot;content-type&quot;:&quot;application/json; charset=UTF-8&quot;,&quot;host&quot;:&quot;polis.nhiro.org&quot;,&quot;origin&quot;:&quot;https://polis.nhiro.org&quot;,&quot;priority&quot;:&quot;u=1, i&quot;,&quot;referer&quot;:&quot;https://polis.nhiro.org/createuser&quot;,&quot;sec-ch-ua&quot;:&quot;\&quot;Google Chrome\&quot;;v=\&quot;125\&quot;, \&quot;Chromium\&quot;;v=\&quot;125\&quot;, \&quot;Not.A/Brand\&quot;;v=\&quot;24\&quot;&quot;,&quot;sec-ch-ua-mobile&quot;:&quot;?0&quot;,&quot;sec-ch-ua-platform&quot;:&quot;\&quot;macOS\&quot;&quot;,&quot;sec-fetch-dest&quot;:&quot;empty&quot;,&quot;sec-fetch-mode&quot;:&quot;cors&quot;,&quot;sec-fetch-site&quot;:&quot;same-origin&quot;,&quot;user-agent&quot;:&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&quot;,&quot;x-forwarded-proto&quot;:&quot;https&quot;,&quot;x-requested-with&quot;:&quot;XMLHttpRequest&quot;},&quot;path&quot;:&quot;/api/v3/auth/new&quot;,&quot;service&quot;:&quot;polis-api-server&quot;,&quot;timestamp&quot;:&quot;2024-06-19 09:34:40 +00:00&quot;}
POST /api/v3/auth/new 500 4.790 ms - 45
unauthorized domain: https://polis.nhiro.org
</code></pre>
<p>well ‚Ä¶ (used before sentences expressing a doubt)</p>
<blockquote>
<p>Could --- <a href="./Polis#646d8611aff09e0000bf04d0-on-ec2" class="internal alias" data-slug="Polis">646d8611aff09e0000bf04d0 on EC2</a>.</p>
</blockquote>
<ul>
<li>How was it done?</li>
</ul>
<p>I remember last time I was confused about having .env and prod.env, and this time I‚Äôve been using prod.env all along.
:</p>
<pre><code># Optionally give the server container a distinct env_file. Useful for CI tests.
SERVER_ENV_FILE=.env
</code></pre>
<p>Maybe it‚Äôs bad to leave this as the default value in prod.env?</p>
<p>Rather, the domainOverride is null, but even if you <code>make PROD start</code>, the <code>prod.env</code> is not being read.
:</p>
<pre><code>$ make PROD start
make: 'PROD' is up to date.
ENV_FILE=prod.env
TAG=dev
docker compose -f docker-compose.yml --env-file prod.env up
</code></pre>
<p>I don‚Äôt think so.</p>
<p>2024-06-21
It is unnatural that prod.env should be read but domainOverride is null, so check there.</p>
<ul>
<li>
<p><a href="./Monitoring-with-CloudWatch" class="internal alias" data-slug="Monitoring-with-CloudWatch">Monitoring with CloudWatch</a></p>
</li>
<li>
<p><a href="./Create-a-list-of-questions-for-the-Polis-test" class="internal alias" data-slug="Create-a-list-of-questions-for-the-Polis-test">Create a list of questions for the Polis test</a></p>
</li>
</ul>
<p>feedback</p>
<ul>
<li>Hosted by: fly.io</li>
<li>Certificate Options: AWS Certificate manager
<ul>
<li>
<blockquote>
<p>ACM and connect it to ALB, where it will be SSL terminated, and the server side will return only HTTP.</p>
</blockquote>
</li>
</ul>
</li>
<li>Cloudwatch does not have memory monitoring and requires customization, so it may be easier to use a SaaS such as datadog.</li>
</ul>
<p>2024-06-22
I haven‚Äôt taken the time at all w</p>
<p>before
<code>SERVER_ENV_FILE=</code>
after
<code>SERVER_ENV_FILE=prod.env</code>
<code>$ make build-no-cahce</code></p>
<p>:</p>
<pre><code>services:
  server:
    env_file:
      - ${SERVER_ENV_FILE:-.env}
</code></pre>
<img src="https://scrapbox.io/api/pages/nishio/gpt/icon" alt="gpt.icon" height="19.5"/>
- SERVER_ENV_FILE is an environment variable that specifies the path to the .env file. The value of this environment variable may change the configuration and behavior of the service. Details are shown below.
    - If not specified (default value .env): .
        - The server uses .env files in the root directory of the project.
            - Uh huh.<img src="https://scrapbox.io/api/pages/nishio/nishio/icon" alt="nishio.icon" height="19.5"/>
                - I think you're getting a little too mixed up...
    - If a specific file is specified:.
        - For example, if SERVER_ENV_FILE=.env.production is specified, the server will use the .env.production file.
<p>:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        15G   15G  253M  99% /
</code></pre>
<p>Would you use as much as you had if you had it?
:</p>
<pre><code>    # Delete all suspended containers
    docker container prune
    # Remove all unused images
    docker image prune -a
    # Delete all unused volumes
    docker volume prune
    # Remove all unused networks
    docker network prune
</code></pre>
<p>:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        15G   14G  627M  96% /
</code></pre>
<p>What‚Äôs bulky?
:</p>
<pre><code>$ sudo du -h --max-depth=1 /
12G     /var
</code></pre>
<p>:</p>
<pre><code>/var$ sudo du -h --max-depth=1 .
12G     ./lib
</code></pre>
<p>:</p>
<pre><code>/var/lib$ sudo du -h --max-depth=1 .
11G     ./docker
</code></pre>
<p>:</p>
<pre><code>$ docker system prune
WARNING! This will remove:
  - all stopped containers
  - all networks not used by at least one container
  - all dangling images
  - unused build cache

Are you sure you want to continue? [y/N] y
Deleted build cache objects:
...
Total reclaimed space: 7.928GB
</code></pre>
<p>Oh, this one.
:</p>
<pre><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        15G  3.5G   12G  24% /
</code></pre>
<p>Maybe if they‚Äôd realized they should have erased the build cache, they wouldn‚Äôt have needed to expand the disk.</p>
<p>return
<code>$ make build-no-cahce</code>
<code>$ make PROD start</code>
<img src="https://gyazo.com/80b314a50c1df680e3a7533ebb239204/thumb/1000" alt="image"/>
It‚Äôs done!</p>
<hr/>
<p>This page is auto-translated from <a href="https://scrapbox.io/nishio/2024%E5%B9%B4%E5%A4%8FPolis%E7%A5%AD%E3%82%8A:%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E6%BA%96%E5%82%99" class="external">/nishio/2024Âπ¥Â§èPolisÁ•≠„Çä:„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÊ∫ñÂÇô<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> using DeepL. If you looks something interesting but the auto-translated English is not good enough to understand it, feel free to let me know at <a href="https://twitter.com/nishio_en" class="external">@nishio_en<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. I‚Äôm very happy to spread my thought to non-Japanese readers.</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="./Summer-Polis-Festival-2024" class="internal">Summer Polis Festival 2024</a></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> ¬© 2024</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="./postscript.js" type="module"></script></html>