<!DOCTYPE html>
<html lang="en"><head><title>How to avoid TLE with memoized recursive DP</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="ü™¥ Quartz 4.0"/><meta property="og:title" content="How to avoid TLE with memoized recursive DP"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="How to avoid TLE with memoized recursive DP"/><meta name="twitter:description" content="There are natural problems to implement with recursive calls. For example, a situation in which a dynamic programming method with non-trivial traversal order is implemented by a memory recursion call Python is heavy on numerical operations, so dynamic programming with many operations is easy to TLE."/><meta property="og:description" content="There are natural problems to implement with recursive calls. For example, a situation in which a dynamic programming method with non-trivial traversal order is implemented by a memory recursion call Python is heavy on numerical operations, so dynamic programming with many operations is easy to TLE."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="There are natural problems to implement with recursive calls. For example, a situation in which a dynamic programming method with non-trivial traversal order is implemented by a memory recursion call Python is heavy on numerical operations, so dynamic programming with many operations is easy to TLE."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:width" content="1200"/><meta property="og:height" content="630"/><meta property="og:image:url" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta name="twitter:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="twitter:domain" content="quartz.jzhao.xyz"/><meta property="og:url" content="https:/quartz.jzhao.xyz/How-to-avoid-TLE-with-memoized-recursive-DP"/><meta property="twitter:url" content="https:/quartz.jzhao.xyz/How-to-avoid-TLE-with-memoized-recursive-DP"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="There are natural problems to implement with recursive calls. For example, a situation in which a dynamic programming method with non-trivial traversal order is implemented by a memory recursion call Python is heavy on numerical operations, so dynamic programming with many operations is easy to TLE."/><meta name="generator" content="Quartz"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("./static/contentIndex.json").then(data => data.json())</script></head><body data-slug="How-to-avoid-TLE-with-memoized-recursive-DP"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href=".">ü™¥ Quartz 4.0</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="./">Home</a><p> ‚ùØ </p></div><div class="breadcrumb-element"><a href>How to avoid TLE with memoized recursive DP</a></div></nav><h1 class="article-title">How to avoid TLE with memoized recursive DP</h1><p show-comma="true" class="content-meta"><span>Sep 14, 2020</span><span>7 min read</span></p></div></div><article class="popover-hint"><ul>
<li>There are natural problems to implement with recursive calls.
<ul>
<li>For example, a situation in which a dynamic programming method with non-trivial traversal order is implemented by a <a href="./memory-recursion" class="internal alias" data-slug="memory-recursion">memory recursion</a> call</li>
</ul>
</li>
<li>Python is heavy on numerical operations, so dynamic programming with many operations is easy to TLE.</li>
<li>With PyPy, function calls are slow, so it‚Äôs easy to TLE if you overuse recursive calls.
- <a href="./PyPy-function-calls-are-slow" class="internal alias" data-slug="PyPy-function-calls-are-slow">PyPy function calls are slow</a></li>
<li>I usually use Numba to compile AOT to speed up the process‚Ä¶
<ul>
<li>Numba does not support recursive calls to functions within functions.</li>
<li>Placing it outside the function is not possible with AOT.</li>
<li>JIT can be done, but it is compiled during the execution phase, which is not good for speed.</li>
</ul>
</li>
<li>With Cython, could this be an effective way to compile a function by specifying that it is only called from C?
<ul>
<li>‚ÜíFastest at the moment</li>
</ul>
</li>
</ul>
<p>Use <a href="https://atcoder.jp/contests/dp/tasks/dp_g" class="external">G - Longest Path<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> to find the longest path in a graph as a target problem</p>
<ul>
<li>Use the execution speed of test cases 1_17, 1_01 on the AtCoder server for speed comparison
<ul>
<li>1_01 is the largest one, but I also used 1_17, which is one size smaller, because I couldn‚Äôt tell the time when it timed out.</li>
</ul>
</li>
</ul>
<p>Execution time summary
| 1_17 | 1_01 |
| ‚Äî | ‚Äî | ‚Äî | ‚Äî |
| 653 ms TLE Code1 Python Rustic Memorized Recursion |
| 422 ms | TLE | Code1 PyPy |
| 735 ms TLE Code2 Python memoizing dict‚Üílist |
| 378 ms | 485 ms | Code2 PyPy |
| 434 ms 565 ms Check for computation before calling Code3 Python functions |
| 498 ms | 352 ms | Code3 PyPy |
| 169 ms | 223 ms | Code4 Cython |
| 142 ms 177 ms Code5 Cython memoization array to C array |
| 148 ms 164 ms (best) Code6 Cython End-of-search conditional branching outside of recursion first |
| 1209 ms | 1225 ms | Code7 Numba | JIT |
| 295 ms 368 ms Code8 Python Depth-first search in return order |
| 253 ms | 256 ms | Code8 PyPy |</p>
<p>Code1: Rustic memoization recursion</p>
<ul>
<li>Python 653 ms TLE <a href="https://atcoder.jp/contests/dp/submissions/14906600" class="external">https://atcoder.jp/contests/dp/submissions/14906600<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>PyPy 422 ms TLE <a href="https://atcoder.jp/contests/dp/submissions/14906630" class="external">https://atcoder.jp/contests/dp/submissions/14906630<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
python</li>
</ul>
<pre><code>from collections import defaultdict
import sys

sys.setrecursionlimit(10**6)


def solve(N, M, edges):
    longest = {}

    def get_longest(start):
        if start in longest:
            return longest[start]

        next_edges = edges.get(start)
        if not next_edges:
            ret = 0
        else:
            ret = max(get_longest(v) for v in edges[start]) + 1
        longest[start] = ret
        return ret

    return max(get_longest(v) for v in edges)


def main():
    N, M = map(int, input().split())
    edges = defaultdict(set)
    for i in range(M):
        v1, v2 = map(int, input().split())
        edges[v1].add(v2)

    print(solve(N, M, edges))


main()
</code></pre>
<p>Code2: Version changed to list in case anyone wonders about the use of dict for memoization.</p>
<ul>
<li>Python  735 ms TLE  <a href="https://atcoder.jp/contests/dp/submissions/14907532" class="external">https://atcoder.jp/contests/dp/submissions/14907532<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>PyPy 378 ms AC 1_01: 485 ms <a href="https://atcoder.jp/contests/dp/submissions/14907612" class="external">https://atcoder.jp/contests/dp/submissions/14907612<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>It‚Äôs possible that PyPy isn‚Äôt good at accessing dict from this feeling (needs verification).
python</li>
</ul>
<pre><code>def solve(N, M, edges):
    longest = [-1] * (N + 1)
    for i in range(N + 1):
        if not edges[i]:
            longest[i] = 0

    def get_longest(start):
        ret = longest[start]
        if ret != -1:
            return ret

        next_edges = edges.get(start)
        if not next_edges:
            ret = 0
        else:
            ret = max(get_longest(v) for v in edges[start]) + 1
        longest[start] = ret
        return ret

    return max(get_longest(v) for v in edges)
</code></pre>
<p>Code3 Version to check for computed before function call</p>
<ul>
<li>Python 434 ms / 565 ms <a href="https://atcoder.jp/contests/dp/submissions/14916958" class="external">https://atcoder.jp/contests/dp/submissions/14916958<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>PyPy 498 ms / 352 ms <a href="https://atcoder.jp/contests/dp/submissions/14907832" class="external">https://atcoder.jp/contests/dp/submissions/14907832<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>Reduce the number of function calls by one last call</li>
</ul>
<p>Code4 Cython
cython</p>
<pre><code>cdef get_longest(long start, dict edges, long[:] longest):
    if longest[start] != -1:
        return longest[start]

    cdef list next_edges
    next_edges = edges.get(start)
    if not next_edges:
        ret = 0
    else:
        #ret = max(get_longest(v, edges, longest) for v in edges[start]) + 1
        ret = 0
        for v in edges[start]:
            x = get_longest(v, edges, longest) + 1
            if x > ret:
                ret = x

    longest[start] = ret
    return ret


def solve(N, M, edges):
    cdef array.array longest = pyarray.array('l', [-1] * (N + 1))
    return max(get_longest(v, edges, longest) for v in edges)	 
</code></pre>
<ul>
<li>AC 169 ms / 223 ms <a href="https://atcoder.jp/contests/dp/submissions/14906046" class="external">https://atcoder.jp/contests/dp/submissions/14906046<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>I couldn‚Äôt cdef it as a function within a function, so I took it out.
- <a href="./Cython-does-not-allow-function-definitions-within-functions" class="internal alias" data-slug="Cython-does-not-allow-function-definitions-within-functions">Cython does not allow function definitions within functions</a></li>
<li>Listing access seemed slow, so I changed it to ARAY.
<ul>
<li>This doesn‚Äôt seem to matter see <a href="./Declaring-subscripts-as-type-in-Cython-is-not-fast" class="internal alias" data-slug="Declaring-subscripts-as-type-in-Cython-is-not-fast">Declaring subscripts as type in Cython is not fast</a>.</li>
</ul>
</li>
<li>Generator comprehensions were causing problems, so I rewrote them into a for loop.
- <a href="./Cython-and-generator-inclusions" class="internal alias" data-slug="Cython-and-generator-inclusions">Cython and generator inclusions</a></li>
</ul>
<p>Put Code5 longest globally as an array in C</p>
<ul>
<li>142 ms / 177 ms</li>
<li>I wanted a C array, not a list or an array. Related: <a href="./Declaring-subscripts-as-type-in-Cython-is-not-fast" class="internal alias" data-slug="Declaring-subscripts-as-type-in-Cython-is-not-fast">Declaring subscripts as type in Cython is not fast</a>.</li>
<li><a href="https://atcoder.jp/contests/dp/submissions/14913275" class="external">https://atcoder.jp/contests/dp/submissions/14913275<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
</ul>
<p>Code6 Conditional branching on whether there is an outgoing edge or not is done first outside of the recursion.</p>
<ul>
<li>148 ms / 164 ms</li>
<li><a href="https://atcoder.jp/contests/dp/submissions/14913765" class="external">https://atcoder.jp/contests/dp/submissions/14913765<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
</ul>
<p>Numba</p>
<ul>
<li>Aside from speed, Numba is a lot harder to get working than Cython, which works without doing anything.
<ul>
<li><code>ret = max(get_longest(v) for v in edges[start]) + 1</code>
<ul>
<li><code>The use of yield in a closure is unsupported.</code></li>
</ul>
</li>
<li><a href="https://gist.github.com/nishio/dd3013df3e88ef1afb0d41d5980a3882" class="external">https://gist.github.com/nishio/dd3013df3e88ef1afb0d41d5980a3882<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
<ul>
<li><code>Compilation is falling back to object mode WITH looplifting enabled because Function &quot;get_longest&quot; failed type inference due to: non-precise type pyobject</code></li>
<li>The approach of simply attaching numba.jit does not work, the argument must be an object that allows type inference</li>
</ul>
</li>
</ul>
</li>
<li>Difficulty in handling graphs in adjacency list format
<ul>
<li>If you make it comfortably in Python, it‚Äôs dafaultdict(list), but neither dict nor list is appropriate.</li>
<li>Since it is variable length, a messy np.array will result in a space of N * M</li>
<li>I think it would be best to pass it as a sequence of integers and make it a concatenated list in the Numba world.
<ul>
<li>In this problem, the maximum number of graph edges is fixed, so np.array of that size is allocated.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Code7: Numba JIT</p>
<ul>
<li>1209 ms / 1225 ms <a href="https://atcoder.jp/contests/dp/submissions/14915733" class="external">https://atcoder.jp/contests/dp/submissions/14915733<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li>It‚Äôs significantly slower than anything I‚Äôve ever seen, and I‚Äôve been through it a lot.
<ul>
<li>But the difference in time between the two problems was 16 ms, about the same as the fastest Cython implementation.</li>
<li>This means that the JIT is compiled during the execution phase, which eats up time, but the pre-compiled version is faster.</li>
<li>This is also the reason why I usually use Numba with AOT. If you can AOT compile during the compile phase, there is no need to JIT compile during the run phase.</li>
</ul>
</li>
<li>Numba AOT fails at compile time
<ul>
<li><code>Untyped global name 'get_longest': cannot determine Numba type of &lt;class 'function'></code>
<ul>
<li>This is because what humans perceive as a recursive call is, for Python, ‚Äúget a global variable and call it‚Äù.
<ul>
<li>The type of the retrieved global variable is unknown because the name may be re-bound to another with the same name after the function definition.</li>
<li>However, this is inconvenient, so for example, a recursive call could be made possible by a human declaring at compile time that ‚Äúa call to the same name variable within this function is a call to this function itself‚Äù, which might be included in a future Numba, I hope!</li>
<li>JIT can do it, so why not AOT?</li>
</ul>
</li>
</ul>
</li>
<li>So far I haven‚Äôt found a way to AOT a recursive function that is not tail-recursive with Numba.</li>
</ul>
</li>
</ul>
<p>Code8: Proposal to process depth-first search in the order of return</p>
<ul>
<li>The idea is that you don‚Äôt have to use recursive calls in the first place, just search the call tree in depth priority and process it on the way back.
python</li>
</ul>
<pre><code>def solve(N, M, edges):
    longest = {}

    stack = [v for v in edges]

    while stack:
        v = stack.pop()
        if v > 0:
            if v in longest:
                continue
            next_edges = edges.get(v)
            stack.append(-v)
            if next_edges:
                stack.extend(next_edges)
        else:
            next_edges = edges.get(-v)
            if not next_edges:
                ret = 0
            else:
                ret = max(longest[x] for x in next_edges) + 1
            longest[-v] = ret

    return max(longest[v] for v in edges)
</code></pre>
<p>Python 295 ms / 368 ms <a href="https://atcoder.jp/contests/dp/submissions/14916269" class="external">https://atcoder.jp/contests/dp/submissions/14916269<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
PyPy 253 ms / 256 ms <a href="https://atcoder.jp/contests/dp/submissions/14916290" class="external">https://atcoder.jp/contests/dp/submissions/14916290<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<hr/>
<p>This page is auto-translated from <a href="https://scrapbox.io/nishio/%E3%83%A1%E3%83%A2%E5%8C%96%E5%86%8D%E5%B8%B0DP%E3%81%A7TLE%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%AB%E3%81%AF" class="external">/nishio/„É°„É¢ÂåñÂÜçÂ∏∞DP„ÅßTLE„ÇíÈÅø„Åë„Çã„Å´„ÅØ<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> using DeepL. If you looks something interesting but the auto-translated English is not good enough to understand it, feel free to let me know at <a href="https://twitter.com/nishio_en" class="external">@nishio_en<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. I‚Äôm very happy to spread my thought to non-Japanese readers.</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li>No backlinks found</li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> ¬© 2024</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="./postscript.js" type="module"></script></html>