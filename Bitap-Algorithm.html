<!DOCTYPE html>
<html lang="en"><head><title>Bitap Algorithm</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="🪴 Quartz 4.0"/><meta property="og:title" content="Bitap Algorithm"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Bitap Algorithm"/><meta name="twitter:description" content="..."/><meta property="og:description" content="..."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="..."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:width" content="1200"/><meta property="og:height" content="630"/><meta property="og:image:url" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta name="twitter:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="twitter:domain" content="quartz.jzhao.xyz"/><meta property="og:url" content="https:/quartz.jzhao.xyz/Bitap-Algorithm"/><meta property="twitter:url" content="https:/quartz.jzhao.xyz/Bitap-Algorithm"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="..."/><meta name="generator" content="Quartz"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("./static/contentIndex.json").then(data => data.json())</script></head><body data-slug="Bitap-Algorithm"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href=".">🪴 Quartz 4.0</a></h2><div class="spacer mobile-only"></div><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="./">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Bitap Algorithm</a></div></nav><h1 class="article-title">Bitap Algorithm</h1><p show-comma="true" class="content-meta"><span>Apr 05, 2019</span><span>6 min read</span></p></div></div><article class="popover-hint"><blockquote>
<p>Bitap algorithm is a string search algorithm that uses the parallelism of bitwise operations
Also called Baeza-Yates-Gonnet algorithm, Shift-and algorithm and Shift-or algorithm
<a href="./ambiguous-retrieval" class="internal alias" data-slug="ambiguous-retrieval">ambiguous retrieval</a>, which is a feature not found in other string search algorithms.</p>
</blockquote>
<ul>
<li>
<p><a href="https://ja.wikipedia.org/wiki/Bitap%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0" class="external">Bitap algorithm - Wikipedia<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
</li>
<li>
<blockquote>
<p>‘bitap’ (bit-parallel approximate pattern matching)</p>
</blockquote>
</li>
<li>
<p>Implemented in <a href="./asearch" class="internal" data-slug="asearch">asearch</a>.</p>
</li>
</ul>
<p>Start with a simple “unambiguous search” explanation
<img src="https://gyazo.com/32dc88bb9200d0663c6cdc643ea29938/thumb/1000" alt="image"/>
Use this kind of linear <a href="./NFA" class="internal" data-slug="NFA">NFA</a> to determine string acceptance.
Pack 1 bit of whether or not you are in each state into an integer so you can use AND and shift operations.
In the case of this figure</p>
<ul>
<li>Initial condition 100</li>
<li>Acceptance state mask accept 001</li>
<li>Mask corresponding to character a 100</li>
<li>Mask corresponding to character b 010
<ul>
<li>The bit stands in the root state where the arrow grows that transitions to the next state in that character.</li>
</ul>
</li>
<li>State update: <code>state = (state &amp; mask) >> 1</code>.</li>
<li>Acceptance decision: <code>state &amp; accept ! = 0</code></li>
</ul>
<p>This pattern matches “ab” in regular expression. *a.*b”, but you can easily change it to match “.
<img src="https://gyazo.com/0af6aed29ac322dd24d4577d7490b892/thumb/1000" alt="image"/></p>
<ul>
<li>Masking transitions with arbitrary characters eps 110
<ul>
<li>Bits stand in the root state of the growing transition in any character.</li>
</ul>
</li>
<li>state update: <code>state = (state &amp; eps) | (state &amp; mask) >> 1</code>.
<ul>
<li>Once the standing state of 1 in the eps mask is 1, it will remain 1 for the rest of the time.</li>
</ul>
</li>
<li>The implementation of <a href="./asearch" class="internal" data-slug="asearch">asearch</a> uses 0x20 as the character meaning this transition</li>
</ul>
<p>ambiguous retrieval
<img src="https://gyazo.com/4fc58b867e8bbde5eaafafd6cf7d75da/thumb/1000" alt="image"/></p>
<ul>
<li>Express a pattern that tolerates a single character error as a separate integer
<ul>
<li>I was going to explain each of these transitions (1), (2), and (3), but there seems to be a discrepancy between the diagram in the explanation and the implementation.</li>
</ul>
</li>
<li>Regarding the transition in (3)
<ul>
<li>The figure in [/masui/ambiguous search asearch](<a href="https://scrapbox.io/masui/ambiguous" class="external">https://scrapbox.io/masui/ambiguous<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> search asearch) is b</li>
<li><img src="https://gyazo.com/d3884cc7d269be9eed5de95a28b261f0/thumb/1000" alt="image"/></li>
<li>However, asearch’s implementation does <code>i1 |= (i0 >> 1)</code> after updating i0, so the transition is at a.</li>
<li>The implementation of ”*” transitions and asearch in this figure appear to be “transitions with any one character” rather than “epsilon transitions that do not consume a character”.
<ul>
<li>(Although the variable name epsilon is used in the asearch implementation.)</li>
</ul>
</li>
<li>hence
<ul>
<li>If implemented as shown in the NFA diagram, “ab” accepts “b” and does not accept “a</li>
<li>The current implementation of asearch accepts “a” and does not accept “b</li>
</ul>
</li>
<li>If the transition is an epsilon transition that does not consume a character, both “a” and “b” are accepted even without the Katsurabayashi transition (3).
<ul>
<li><img src="https://gyazo.com/515ce7163d379ad3ffc1c5368a9c456b/thumb/1000" alt="image"/></li>
<li>Not yet examined whether it would be easy to implement this in bitwise operations.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a href="https://github.com/masui/asearch-ruby" class="external">https://github.com/masui/asearch-ruby<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>
ruby</p>
<pre><code>chars.each { |c|
  mask = @shiftpat[c]
  i3 = (i3 &amp; @epsilon) | ((i3 &amp; mask) >> 1) | (i2 >> 1) | i2
  i2 = (i2 &amp; @epsilon) | ((i2 &amp; mask) >> 1) | (i1 >> 1) | i1
  i1 = (i1 &amp; @epsilon) | ((i1 &amp; mask) >> 1) | (i0 >> 1) | i0
  i0 = (i0 &amp; @epsilon) | ((i0 &amp; mask) >> 1)
  i1 |= (i0 >> 1)
  i2 |= (i1 >> 1)
  i3 |= (i2 >> 1)
}
</code></pre>
<ul>
<li>Look at the definition of <a href="./Levenshtein-Distance" class="internal alias" data-slug="Levenshtein-Distance">Levenshtein Distance</a> and think about what transitions there should be.</li>
<li><img src="https://gyazo.com/222b0f954e5cbd652709f8af937e4958/thumb/1000" alt="image"/>
<ul>
<li>Inserting a single character is only required if a transition to the top occurs when any single character arrives, regardless of the character, so
<ul>
<li><code>i1 |= i0</code></li>
</ul>
</li>
<li>The one-character replacement is good if the transition to the upper right occurs when any one character arrives, regardless of the character, so
<ul>
<li><code>i1 |= (i0 >> 1)</code></li>
</ul>
</li>
<li>It is troublesome that one character deletion is an epsilon transition that does not consume a character.
<ul>
<li>Transition to “when the previous character arrives” while you are at it.</li>
<li>So after the character-consuming transition <code>i1 |= (i0 >> 1)</code></li>
</ul>
</li>
<li>Think of it this way, there is no problem with the transition part of asearch’s implementation</li>
<li>Here’s the problem.
ruby</li>
</ul>
</li>
</ul>
<pre><code>def initstate
  [INITPAT, 0, 0, 0]
end
</code></pre>
<pre><code>    - The epsilon transition before the first character comes in, i1 to i3 should also have bits standing, but they are set to 0.
- As for the diagram, if you draw it using the epsilon transition, it means that the diagonal transition includes epsilon, but if you draw it without using it, that diagonal transition is a two way transition by the mechanism of [[Bitap algorithm#5ca57e73aff09e0000f994fd|5ca57e73aff09e0000f994fd]], so both a and b for the cinnabar jumping line Therefore, it seems correct to draw both a and b on the cinnabar jumping line.
</code></pre>
<p>Other Topics</p>
<ul>
<li>The mask (shiftpat) for each character indicates “which state is the transition source when the character arrives”, so for example, if you set up bits in both the mask for “a” and the mask for “A”, case-insensitive matching is possible.
<ul>
<li>Not just case-insensitive, but any type of transition with multiple types of single characters. For example \d.</li>
</ul>
</li>
<li>On the other hand, “character-by-character mask” is required for each character, so it is necessary to devise a way to match a Japanese string.
<ul>
<li>The asearch implementation splits a character into multiple bytes and matches byte by byte.
<ul>
<li>cons: A difference of one character in Japanese is the same as a difference of two characters in fuzzy search
<ul>
<li>If one of the two bytes happens to match, it’s a one-letter difference.</li>
</ul>
</li>
</ul>
</li>
<li>In my implementation, I only take the lower 1 byte of information and discard the rest.
:</li>
</ul>
</li>
</ul>
<pre><code>>>> ensure_bytes(&quot;Hello&quot;)
b'S\x93kao'
</code></pre>
<pre><code>    - We consider the probability that the lower 1 byte of a Japanese string of some length (from 5 characters) happens to be a string that makes sense in an ASCII string to be negligibly small.
        - cons: If you use 0x20 for a special meaning character like in the asearch implementation, you will get unexpected behavior when a Japanese character happens to be that character.
</code></pre>
<ul>
<li>velocity
<ul>
<li>I did an ambiguous search with a query of length 20 on a set of 25743 page titles obtained by crawling Scrapbox and found min 29, max 47, med 33 msec.</li>
</ul>
</li>
</ul>
<hr/>
<p>This page is auto-translated from <a href="https://scrapbox.io/nishio/Bitap%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0" class="external">/nishio/Bitapアルゴリズム<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> using DeepL. If you looks something interesting but the auto-translated English is not good enough to understand it, feel free to let me know at <a href="https://twitter.com/nishio_en" class="external">@nishio_en<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. I’m very happy to spread my thought to non-Japanese readers.</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="./Key-phrase-extraction-2019-04-02" class="internal">Key phrase extraction 2019-04-02</a></li><li><a href="./Re:2022-08-19" class="internal">Re:2022/08/19</a></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> © 2024</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="./postscript.js" type="module"></script></html>